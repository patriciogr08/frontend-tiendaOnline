<ion-content class="ion-padding">

    <!-- Pull-to-refresh -->
    <ion-refresher slot="fixed" (ionRefresh)="reload($event)">
        <ion-refresher-content></ion-refresher-content>
    </ion-refresher>

    <!-- Búsqueda -->
    <ion-searchbar placeholder="Buscar productos..." (ionInput)="onSearch($event)"></ion-searchbar>

    <!-- Multi-select de tipos -->
    <ion-item lines="none" class="tipos-select">
        <ion-select
            label="Tipos de producto"
            labelPlacement="stacked"
            placeholder="Selecciona uno o varios"
            [multiple]="true"
            interface="popover"
            [value]="selectedTipos"
            (ionChange)="onTipoChange($event)">
            <ion-select-option *ngFor="let t of tipos" [value]="t.id">{{ t.nombre }}</ion-select-option>
        </ion-select>
    </ion-item>

    <!-- Chips de tipos seleccionados -->
    @if(selectedTipos.length){
        <div class="chips-wrap"> 
            <ion-chip class="chip-reset" (click)="clearTipos()">
                <ion-label>Limpiar</ion-label>
            </ion-chip>
            @for (id of selectedTipos; track id) {
            <ion-chip outline="true" (click)="removeTipo(id)">
                <ion-label>{{ tipoNombre(id) }}</ion-label>
                <ion-icon name="close-circle" aria-label="Quitar"></ion-icon>
            </ion-chip>
            }
        </div>
    }


    <!-- Grid de productos -->
    <ion-grid fixed>
        <ion-row class="cards">
            <ion-col size="6" sizeMd="4" sizeLg="3" sizeXl="3" *ngFor="let p of items">
                <ion-card class="prod-card compact">
                    <div class="img-wrap">
                        <img [ngSrc]="p.foto_url || 'assets/img/placeholder-product.jpg'" 
                            width="400" height="400" 
                            priority />
                        @if(hasOffer(p)){
                            <ion-chip color="tertiary" class="offer">
                                <ion-icon name="pricetag-outline"></ion-icon>
                                <ion-label>Oferta</ion-label>
                            </ion-chip>
                        }
                    </div>
                    <ion-card-content class="info">
                        <div class="tipo" title="{{ getTipoNombre(p) }}">{{ getTipoNombre(p) }}</div>
                        <div class="name" title="{{ p.nombre }}">{{ p.nombre }}</div>

                        <div class="price">
                            <span class="final">{{ finalPrice(p) | currency:'USD' }}</span>
                            @if(hasOffer(p)){
                                <span class="original">{{ p.precio | currency:'USD' }}</span>
                            }
                        </div>

                        <ion-button size="small" fill="outline" expand="block" (click)="openQty(p)">
                            <ion-icon name="cart-outline" slot="start"></ion-icon>
                            Agregar
                        </ion-button>
                    
                    </ion-card-content>
                </ion-card>
            </ion-col>
        </ion-row>
        @if(loading && items.length === 0){
            <ion-row>
                <ion-col size="12" class="center"><ion-spinner></ion-spinner></ion-col>
            </ion-row>
        }

        @if(!loading && items.length === 0){
            <ion-row>
                <ion-col size="12" class="center">No hay productos publicados</ion-col>
            </ion-row>
        }
    </ion-grid>

    <!-- Infinite scroll -->
    @if(hasMore){
        <ion-infinite-scroll (ionInfinite)="loadMore($event)">
            <ion-infinite-scroll-content loadingSpinner="bubbles" loadingText="Cargando más..."></ion-infinite-scroll-content>
        </ion-infinite-scroll>
    }

</ion-content>
